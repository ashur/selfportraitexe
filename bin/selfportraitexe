#!/usr/bin/env php
<?php

use Huxtable\Bot\History;
use Huxtable\Bot\Output;
use Huxtable\Core\Config;
use Huxtable\Core\File;

$appName = basename( __FILE__ );

$pathBase		= dirname( __DIR__ );
$pathLib		= $pathBase . '/lib';
$pathApp		= $pathLib  . '/Portrait';
$pathCommands	= $pathLib  . '/commands';
$pathVendor		= $pathBase . '/vendor';
$pathData		= '/var/opt/' . $appName;

/*
 * App configuration
 */
$info = require_once( $pathLib . '/info.php' );

/*
 * Initialize autoloading
 */
include_once( $pathApp . '/Autoloader.php' );
Portrait\Autoloader::register();

include_once( $pathVendor . '/huxtable/bot/autoload.php' );
include_once( $pathVendor . '/huxtable/cli/autoload.php' );
include_once( $pathVendor . '/huxtable/core/autoload.php' );
include_once( $pathVendor . '/huxtable/pixel/autoload.php' );

/*
 * Some basics
 */
$dirApp = new File\Directory( $pathBase );
$dirData = new File\Directory( $pathData );
$dirLib = $dirApp->childDir( 'lib' );

/*
 * App configuration
 */
$app = new Huxtable\CLI\Application( $appName, $info['version'], $info['php-min'], $dirApp );

/*
 * Register commands
 */
$fileFilter = new File\Filter();
$fileFilter
->setDefaultMethod( $fileFilter::METHOD_INCLUDE )
->includeFileExtension( 'php' );

$commandsFolder = new File\Directory( $pathCommands );
$commandFiles = $commandsFolder->children( $fileFilter );

foreach( $commandFiles as $commandFile )
{
	$command = include_once( $commandFile );
	if( $command instanceof Huxtable\CLI\Command )
	{
		$app->registerCommand( $command );
	}
}

/*
 * Bot configuration
 */
$pathData = '/var/opt/' . $appName;
$dirData = new File\Directory( $pathData );

/* Bot */
$bot = new Portrait\Bot( 'tinyskylines', $dirData );

/* Attempt to run the requested command */
$app->run();

/* Stop application and exit */
$app->stop();
